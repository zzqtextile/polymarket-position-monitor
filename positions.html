<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŒä»“ç›‘æ§ - Polymarket</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
            background: #0d0e11;
            color: #eaecef;
            padding: 0;
            min-height: 100vh;
        }

        /* é¡¶éƒ¨å¯¼èˆªæ  */
        .navbar {
            background: #1e2329;
            border-bottom: 1px solid #2b3139;
            padding: 0 24px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .navbar .logo {
            font-size: 20px;
            font-weight: 700;
            color: #fcd535;
        }
        .navbar .logo span {
            color: #eaecef;
            font-weight: 400;
        }
        .wallet-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .wallet-input {
            background: #2b3139;
            border: 1px solid #474d57;
            color: #eaecef;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 13px;
            width: 400px;
            font-family: inherit;
        }
        .wallet-input:focus {
            outline: none;
            border-color: #fcd535;
        }
        .refresh-btn {
            background: #fcd535;
            color: #0d0e11;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s;
        }
        .refresh-btn:hover {
            background: #e5c12e;
        }

        /* ä¸»å†…å®¹åŒºåŸŸ */
        .main-content {
            padding: 24px;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* å¸‚åœºåŒºå— */
        .market-block {
            background: #1e2329;
            border: 1px solid #2b3139;
            border-radius: 8px;
            margin-bottom: 24px;
            overflow: hidden;
        }
        .market-header {
            background: #2b3139;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #363c45;
        }
        .market-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .market-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 700;
        }
        .market-icon.btc {
            background: #f7931a;
            color: #fff;
        }
        .market-icon.eth {
            background: #627eea;
            color: #fff;
        }
        .market-name {
            font-size: 16px;
            font-weight: 600;
        }
        .market-time {
            font-size: 12px;
            color: #848e9c;
        }

        /* æ±‡æ€»å¡ç‰‡ */
        .summary-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1px;
            background: #2b3139;
            padding: 16px 24px;
        }
        .summary-item {
            text-align: center;
            padding: 8px;
        }
        .summary-label {
            font-size: 11px;
            color: #848e9c;
            margin-bottom: 4px;
            text-transform: uppercase;
        }
        .summary-value {
            font-size: 20px;
            font-weight: 700;
        }
        .summary-value.green {
            color: #0ecb81;
        }
        .summary-value.red {
            color: #f6465d;
        }

        /* æŒä»“åˆ—è¡¨ */
        .position-row {
            display: grid;
            grid-template-columns: 80px 1fr 120px 120px 120px 140px;
            gap: 16px;
            padding: 16px 24px;
            border-bottom: 1px solid #2b3139;
            align-items: center;
            transition: background 0.2s;
        }
        .position-row:hover {
            background: #2b3139;
        }
        .position-row:last-child {
            border-bottom: none;
        }

        /* è¡¨å¤´ */
        .table-header {
            display: grid;
            grid-template-columns: 80px 1fr 120px 120px 120px 140px;
            gap: 16px;
            padding: 12px 24px;
            background: #1e2329;
            font-size: 11px;
            color: #848e9c;
            text-transform: uppercase;
            border-bottom: 1px solid #2b3139;
        }

        /* æ•°æ®åˆ— */
        .col-side {
            display: flex;
            align-items: center;
        }
        .side-badge {
            padding: 4px 12px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }
        .side-badge.up {
            background: rgba(14, 203, 129, 0.15);
            color: #0ecb81;
        }
        .side-badge.down {
            background: rgba(246, 70, 93, 0.15);
            color: #f6465d;
        }

        .col-market {
            font-size: 14px;
            font-weight: 500;
        }

        .col-size {
            text-align: right;
            font-size: 14px;
            font-weight: 500;
        }

        .col-price {
            text-align: right;
            font-size: 14px;
            color: #848e9c;
        }

        .col-value {
            text-align: right;
            font-size: 14px;
            font-weight: 600;
        }

        .col-pnl {
            text-align: right;
            font-size: 14px;
            font-weight: 600;
        }
        .col-pnl.green {
            color: #0ecb81;
        }
        .col-pnl.red {
            color: #f6465d;
        }

        /* æ ‡ç­¾ */
        .badge-group {
            display: flex;
            gap: 4px;
            margin-left: 8px;
        }
        .badge {
            padding: 2px 6px;
            border-radius: 2px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .badge.redeemable {
            background: #0ecb81;
            color: #0d0e11;
        }
        .badge.mergeable {
            background: #3b82f6;
            color: #fff;
        }

        /* ç©ºçŠ¶æ€ */
        .empty-state {
            padding: 60px 24px;
            text-align: center;
            color: #848e9c;
        }
        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        /* åŠ è½½çŠ¶æ€ */
        .loading-state {
            padding: 80px 24px;
            text-align: center;
            color: #848e9c;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #2b3139;
            border-top-color: #fcd535;
            border-radius: 50%;
            margin: 0 auto 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* é”™è¯¯çŠ¶æ€ */
        .error-state {
            background: rgba(246, 70, 93, 0.1);
            border: 1px solid #f6465d;
            color: #f6465d;
            padding: 16px 24px;
            border-radius: 4px;
            margin-bottom: 24px;
            font-size: 14px;
        }

        /* åº•éƒ¨ä¿¡æ¯ */
        .footer-info {
            text-align: center;
            padding: 24px;
            color: #848e9c;
            font-size: 12px;
        }

        /* å“åº”å¼ */
        @media (max-width: 1024px) {
            .wallet-input {
                width: 280px;
            }
            .summary-row {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        @media (max-width: 768px) {
            .navbar {
                flex-direction: column;
                height: auto;
                padding: 16px;
                gap: 16px;
            }
            .wallet-input {
                width: 100%;
            }
            .position-row, .table-header {
                grid-template-columns: 60px 1fr 80px;
                gap: 8px;
                font-size: 12px;
            }
            .col-price, .col-value {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <div class="navbar">
        <div class="logo">Polymarket <span>Positions</span></div>
        <div class="wallet-section">
            <input
                type="text"
                id="walletInput"
                class="wallet-input"
                placeholder="é’±åŒ…åœ°å€ (0x...)"
                value="0xc891EA46e4591612c92AA913089fbBE8bb29d3AC"
            >
            <button class="refresh-btn" onclick="fetchPositions()">åˆ·æ–°æ•°æ®</button>
        </div>
    </div>

    <!-- é”™è¯¯æç¤º -->
    <div id="error" style="display: none;"></div>

    <!-- åŠ è½½çŠ¶æ€ -->
    <div id="loading" class="loading-state">
        <div class="spinner"></div>
        <div>åŠ è½½æŒä»“æ•°æ®...</div>
    </div>

    <!-- ä¸»å†…å®¹ -->
    <div class="main-content" id="content" style="display: none;"></div>

    <!-- åº•éƒ¨ä¿¡æ¯ -->
    <div class="footer-info" id="lastUpdate"></div>

    <script>
        async function fetchPositions() {
            const wallet = document.getElementById('walletInput').value.trim();
            if (!wallet) {
                showError('è¯·è¾“å…¥é’±åŒ…åœ°å€');
                return;
            }

            hideError();
            showLoading();

            try {
                // ä½¿ç”¨åŸå§‹APIè·å–æŒä»“
                const response = await fetch(`/api/get_positions_raw?wallet=${wallet}`);
                const data = await response.json();

                if (!data.success) {
                    showError(data.error || 'è·å–æŒä»“å¤±è´¥');
                    return;
                }

                if (!data.positions || data.positions.length === 0) {
                    showEmpty();
                    return;
                }

                displayPositions(data.positions, data.markets || {});

            } catch (e) {
                showError('è·å–æŒä»“å¤±è´¥: ' + e.message);
            }
        }

        function displayPositions(positions, markets) {
            hideLoading();
            const content = document.getElementById('content');
            content.style.display = 'block';
            content.innerHTML = '';

            // æŒ‰å¸‚åœºç±»å‹åˆ†ç»„
            const byMarket = { 'BTC': [], 'ETH': [] };
            positions.forEach(pos => {
                const type = pos.market_type || 'BTC';
                byMarket[type].push(pos);
            });

            // ä¸ºæ¯ä¸ªå¸‚åœºåˆ›å»ºæ˜¾ç¤ºåŒºå—
            for (const [marketType, marketPositions] of Object.entries(byMarket)) {
                if (marketPositions.length === 0) {
                    content.innerHTML += createEmptyMarketBlock(marketType);
                    continue;
                }

                // è®¡ç®—æ±‡æ€»
                let totalValue = 0;
                let totalPnl = 0;
                let totalSize = 0;

                // æŒ‰ç»“æœåˆ†ç»„
                const grouped = {};
                marketPositions.forEach(pos => {
                    const outcome = pos.outcome || 'Unknown';
                    if (!grouped[outcome]) {
                        grouped[outcome] = {
                            outcome: outcome,
                            size: 0,
                            avgPrice: 0,
                            totalCost: 0,
                            currentValue: 0,
                            curPrice: pos.curPrice || 0,
                            cashPnl: 0,
                            percentPnl: 0,
                            redeemable: false,
                            mergeable: false,
                            count: 0
                        };
                    }

                    const g = grouped[outcome];
                    const cost = pos.size * pos.avgPrice;
                    g.size += pos.size;
                    g.totalCost += cost;
                    g.currentValue += pos.currentValue;
                    g.cashPnl += pos.cashPnl;
                    g.redeemable = g.redeemable || pos.redeemable;
                    g.mergeable = g.mergeable || pos.mergeable;
                    g.count += 1;

                    g.avgPrice = g.totalCost / g.size;
                    g.percentPnl = ((g.currentValue - g.totalCost) / g.totalCost) * 100;

                    totalValue += g.currentValue;
                    totalPnl += g.cashPnl;
                    totalSize += g.size;
                });

                const pnlClass = totalPnl >= 0 ? 'green' : 'red';

                // æ„å»ºå¸‚åœºåŒºå— HTML
                let marketHtml = `
                    <div class="market-block">
                        <div class="market-header">
                            <div class="market-title">
                                <div class="market-icon ${marketType.toLowerCase()}">
                                    ${marketType === 'BTC' ? 'â‚¿' : 'Î'}
                                </div>
                                <div>
                                    <div class="market-name">${marketType} æ°¸ä¹…åˆçº¦</div>
                                    <div class="market-time">15åˆ†é’Ÿ â€¢ å½“å‰æœŸæƒ</div>
                                </div>
                            </div>
                        </div>

                        <div class="summary-row">
                            <div class="summary-item">
                                <div class="summary-label">æŒä»“æ•°é‡</div>
                                <div class="summary-value">${parseFloat(totalSize).toFixed(2)}</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">å½“å‰ä»·å€¼</div>
                                <div class="summary-value">$${parseFloat(totalValue).toFixed(2)}</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">æœªå®ç°ç›ˆäº</div>
                                <div class="summary-value ${pnlClass}">$${parseFloat(totalPnl).toFixed(2)}</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">ç›ˆäºæ¯”ä¾‹</div>
                                <div class="summary-value ${pnlClass}">${parseFloat(totalValue) > 0 ? ((parseFloat(totalPnl) / parseFloat(totalValue)) * 100).toFixed(2) : '0.00'}%</div>
                            </div>
                        </div>

                        <div class="table-header">
                            <div>æ–¹å‘</div>
                            <div>æ ‡çš„</div>
                            <div style="text-align: right">æŒä»“</div>
                            <div style="text-align: right">å‡ä»·</div>
                            <div style="text-align: right">ç°ä»·</div>
                            <div style="text-align: right">æœªå®ç°ç›ˆäº</div>
                        </div>
                `;

                // æ·»åŠ æŒä»“è¡Œ
                Object.values(grouped).forEach(g => {
                    const pnlClass = g.cashPnl >= 0 ? 'green' : 'red';
                    const sideClass = g.outcome.toLowerCase() === 'up' ? 'up' : 'down';

                    const badges = [];
                    if (g.redeemable) badges.push('<span class="badge redeemable">å¯èµå›</span>');
                    if (g.mergeable) badges.push('<span class="badge mergeable">å¯åˆå¹¶</span>');

                    marketHtml += `
                        <div class="position-row">
                            <div class="col-side">
                                <span class="side-badge ${sideClass}">${g.outcome}</span>
                            </div>
                            <div class="col-market">
                                ${marketType}/USDT
                                ${badges.length > 0 ? `<div class="badge-group">${badges.join('')}</div>` : ''}
                            </div>
                            <div class="col-size">${parseFloat(g.size).toFixed(2)}</div>
                            <div class="col-price">$${parseFloat(g.avgPrice).toFixed(4)}</div>
                            <div class="col-price">$${parseFloat(g.curPrice || 0).toFixed(4)}</div>
                            <div class="col-pnl ${pnlClass}">
                                ${g.cashPnl >= 0 ? '+' : ''}$${parseFloat(g.cashPnl).toFixed(2)}
                                <br>
                                <small style="opacity: 0.7;">${parseFloat(g.percentPnl).toFixed(2)}%</small>
                            </div>
                        </div>
                    `;
                });

                marketHtml += `
                    </div>
                `;

                content.innerHTML += marketHtml;
            }

            // æ›´æ–°æ—¶é—´
            document.getElementById('lastUpdate').textContent =
                'æœ€åæ›´æ–°: ' + new Date().toLocaleString('zh-CN') +
                ' â€¢ æ¯30ç§’è‡ªåŠ¨åˆ·æ–°';
        }

        function createEmptyMarketBlock(marketType) {
            return `
                <div class="market-block">
                    <div class="market-header">
                        <div class="market-title">
                            <div class="market-icon ${marketType.toLowerCase()}">
                                ${marketType === 'BTC' ? 'â‚¿' : 'Î'}
                            </div>
                            <div>
                                <div class="market-name">${marketType} æ°¸ä¹…åˆçº¦</div>
                                <div class="market-time">15åˆ†é’Ÿ â€¢ å½“å‰æœŸæƒ</div>
                            </div>
                        </div>
                    </div>
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“­</div>
                        <div>å½“å‰å¸‚åœºæ— æŒä»“</div>
                    </div>
                </div>
            `;
        }

        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('content').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function showError(msg) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = 'âš ï¸ ' + msg;
            errorDiv.style.display = 'block';
            hideLoading();
            document.getElementById('content').style.display = 'none';
        }

        function hideError() {
            document.getElementById('error').style.display = 'none';
        }

        function showEmpty() {
            hideLoading();
            const content = document.getElementById('content');
            content.innerHTML = `
                <div class="market-block">
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“­</div>
                        <div>å½“å‰å¸‚åœºæ— æŒä»“</div>
                    </div>
                </div>
            `;
            content.style.display = 'block';
        }

        // è‡ªåŠ¨åŠ è½½
        fetchPositions();

        // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°
        setInterval(fetchPositions, 30000);
    </script>
</body>
</html>
